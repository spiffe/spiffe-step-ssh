[Unit]
Description=SPIFFE step-ca SSH Helper %i
After=network-online.target local-fs.target time-sync.target
Wants=network-online.target local-fs.target time-sync.target spire-agent.target
StartLimitIntervalSec=0

[Service]
Restart=always
RestartSec=5s
Environment="SPIFFE_ENDPOINT_SOCKET=/var/run/spire/agent/sockets/%i/public/api.sock"
Environment="SPIFFE_STEP_SSH_INSTANCE=%i"
EnvironmentFile=-/etc/spiffe/step-ssh/%i.conf
ExecStart=spiffe-helper -config /var/run/spiffe/step-ssh-server/%i/helper-fetchca.conf
ExecStartPre=mkdir -p /var/run/spiffe/step-ssh-server-server/%i
ExecStartPre=chmod 700 /var/run/spiffe/step-ssh-server/%i
ExecStartPre=cp -af /usr/libexec/spiffe/step-ssh-server/helper-fetchca.conf /var/run/spiffe/step-ssh-server/%i/helper-fetchca.conf
ExecStartPre=cp -af /usr/libexec/spiffe/step-ssh-server/nginx-fetchca.conf /var/run/spiffe/step-ssh-server/%i/nginx-fetchca.conf
ExecStartPre=/bin/sed -i "s^@CD@^/var/run/spiffe/step-ssh-server/%i^" /var/run/spiffe/step-ssh-server/%i/helper-fetchca.conf
ExecStartPre=/bin/sed -i "s^@INSTANCE@^%i^" /var/run/spiffe/step-ssh-server/%i/nginx-fetchca.conf

[Install]
WantedBy=multi-user.target
